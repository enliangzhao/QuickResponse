<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>QuickResponser</title>
</head>

<body>
    <nav>
        <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>
        <p > QucikResponser </p>> 
     </nav>
   
     <ul id="slide-out" class="sidenav">
       <li><div class="user-view">
         <div class="background">
           <img src="../images/touxiang.jpg">
         </div>
         <a href="#user"><img class="circle" src="../images/touxiang.jpg"></a>
         <a href="#name"><span class="white-text name">John Doe</span></a>
       </div></li>
       <li><a href="/user_profile">Profile</a></li>
       <li><a href="#!">Notifications</a></li>
     </ul>
      
      <div class="crime_history">
        <b><p><font size="5">&nbsp;&nbsp;Crime History</font><p></b>
        <b><p><font size="2">&nbsp;&nbsp;Address</font><p></b>
        <input id="crime_history_address">
            Please enter the the address you want to search for.
        </input>
        <b><p><font size="2">&nbsp;&nbsp;Within</font><p></b>
        <input id="crime_history_distance">
            In miles.
        </input>  
        <b><p><font size="2">&nbsp;&nbsp;Start Date</font><p></b>
        <input type="date" id="start" name="trip-start"
            value="2021-07-22"
            min="1900-01-01" max="2025-12-31">
        <b><p><font size="2">&nbsp;&nbsp;End Date</font><p></b>
        <input type="date" id="end" name="trip-start"
            value="2021-11-22"
            min="1900-01-01" max="2025-12-31">
        <button type="button" class="btn btn-default" id="reset-button">Reset Filters</button>
        <button type="button" class="btn btn-default" id="search-button">Search</button>
      </div>
      
      <div class="container" >
        <table class="table table-striped" style="font-size:12px" id="table" style="visibility:hidden">
        </table>
      </div>

      <div class="footer">
        <button class='btn btn-primary' onclick="window.location.href='/';"><i class="large material-icons">home</i></button>
        <button class='btn btn-primary' onclick="window.location.href='post_report';"><i class="large material-icons">report</i></button>
        <button class='btn btn-primary' onclick="window.location.href='access_crime_history';"><i class="large material-icons">history</i></button>
        <button class='btn btn-primary' onclick="window.location.href='statistics';"><i class="large material-icons">insert_chart</i></button>
      </div>


</body>
</html>

<style>
    html{
        width: 100%;
        height: 100%;
    }
    body{
        height: 100%;
       
    }
    nav{
        margin: 0 !important;
        height: 10% !important;
       
    }

    .right{
        float: right;
    }
    .title_{
        margin-left: 50%;
    }
    
    .breadcrumb{
        margin: 0 !important;
        height: 5% !important;
        padding: 0;
        text-align: left;
    }
    .breadcrumb ol{
        margin: 0;
       
    }
    .crime_history{
        margin: auto !important;
        height: 55%;
        width: 70%;
        background-color:white;
    }

    .container {
        height: 25%;
        width: 80%;
        overflow: scroll;
    }

    .footer{
        height: 10%;
        display:flex;
        justify-content: space-around;
        align-items: center;
        background-color: rgb(244, 156, 171);
    }

    /* Style buttons */
    .btn {
    background-color: DodgerBlue; /* Blue background */
    border: none; /* Remove borders */
    color: white; /* White text */
    font-size: 16px; /* Set a font size */
    cursor: pointer; /* Mouse pointer on hover */
    }
    .btn i {
        font-size: 22px;
    }
    /* Darker background on mouse-over */
    .btn:hover {
        background-color: RoyalBlue;
    }

    label {
    display: block;
    font: 1rem 'Fira Sans', sans-serif;
    color: black;
    font-size: medium;
    }

    input,
    label {
        margin: .4rem 0;
    }

    
    
</style>


<script>
            
    
        $(function () {
            $('#search-button').click(function () {
                // document.getElementById("table").style.visibility = "";
                console.log('search');
                // console.log(verifyInput());
                if(verifyInput() == 1) viewTable();
            });

            $('#reset-button').on('click', function () {
                // document.getElementById("table").style.visibility = "";
                console.log('reset');
                location.reload();
            });

            function verifyInput() {
                if ($('#crime_history_address').val() == "") {
                    alert('Please type your address');
                    return -1;
                }
                if ($('#crime_history_distance').val() == "") {
                    alert('Please add the distance you want to select');
                    return -1;
                }
                console.log(isNaN($('#crime_history_distance').val()))
                if (isNaN($('#crime_history_distance').val())) {
                    alert('Please make sure distance is a number');
                    return -1;
                }
                return 1;
            }

            function createTable(res) {
                $('#table').append('<tbody id="table-body"></tbody>');
                $('#table').append('<thead><tr><th>Sender</th><th>Type</th><th>Distance</th><th>Time</th><th>Details</th></tr></thead>')
                const crime = ["Bomb", "Gun shot", "Robbery", "Drugs", "Thef"];
                for (var i = 0; i < res.length; i++) {
                    ele = res[i];
                    var date = new Date(ele.time);
                    console.log(date.toUTCString());
                    $('#table-body').append(`<tr><td>${res[i].sender}</td><td>${crime[res[i].crime_type]}</td><td>${(((ele.longtitude - 37.4) * (ele.longtitude - 37.4) + (ele.latitude + 122) * (ele.latitude + 122))*1000).toFixed(2)}</td><td>${date.toUTCString()}</td><td><button type="button" class="btn btn-default" id="detail-button${i}">Details</button></td></tr>`);
                }
            }

            function viewTable() {
                // $(".alert").alert('close');
                const data = {
                    location: $('#crime_history_address').val(),
                    distance: $('#crime_history_distance').val(),
                    start: $('#start').val(),
                    end: $('#end').val(),
                }

                // document.getElementById("table").style.visibility = "";
                console.log(data);
                $.ajax({
                    method: 'POST',
                    url: `/access_crime_history/search_result`,
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    statusCode: {
                        403: (res) => {
                            console.log(res);
                        },
                        /* Handle the successful registration response */
                        200: (res) => {
                            console.log(res);
                            $('#table-body').empty();
                            $('#table').empty();

                            if (res.length == 0) {
                                alert( 'There is no data given the filters');
                                return;
                            }
                            tableData=res;
                            createTable(tableData);                        
                            $.ajax({
                                method: 'POST',
                                url: `/statistics/months`,
                                contentType: 'application/json',
                                data: JSON.stringify(data),
                                statusCode: {
                                    403: (res) => {
                                        console.log(res);
                                    },
                                    /* Handle the successful registration response */
                                    200: (res) => {
                                        //console.log(res);

                                        parseData(res);
                                    },
                                },
                            });
                        },
                    },
                });

            }
        })
    
</script>

<script src="../js/common.js"></script>
